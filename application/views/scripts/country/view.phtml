<?php
$kpis = Model_Campaign::getKpis();
/** @var $presences Model_Presence[] */
$presences = $this->country->presences;
?>

Audience size: <?php echo number_format($this->country->audience); ?>

<?php if (!$presences) : ?>

<h3>No presences found</h3>

<?php else : ?>

<h3>Presences: <?php echo count($presences); ?></h3>

<table class="text">
	<tr>
		<th>Handle</th>
		<th>Audience</th>
		<th>Target audience</th>
		<?php foreach ($kpis as $key=>$label) : ?>
		<th><?php echo $label; ?></th>
		<?php endforeach; ?>
	</tr>

	<?php foreach ($presences as $presence) : ?>
	<tr>
		<td>
			<div class="presence <?php echo $presence->type; ?>">
				<?php echo $this->gatekeeper()->filter('<a href="%url%">' . $presence->handle . '</a>', array('controller'=>'presence', 'action'=>'view', 'id'=>$presence->id)); ?>
				<a href="<?php echo $presence->page_url; ?>" target="_blank" class="icon external"></a>
			</div>
		</td>
		<td><?php echo number_format($presence->popularity) . ' ' . ($presence->type == Model_Presence::TYPE_FACEBOOK ? 'fans' : 'followers'); ?></td>
		<td><?php echo number_format($presence->getTargetAudience()); ?></td>
		<?php $kpiData = $presence->getKpiData(); foreach ($kpis as $key=>$label) : $value = $kpiData[$key]; ?>
		<td>
			<div class="traffic-light" style="background-color:<?php echo $this->trafficLight()->color($value, $key); ?>;"></div>
			<?php echo $this->trafficLight()->label($value, $key); ?>
		</td>
		<?php endforeach; ?>
	</tr>
	<?php endforeach; ?>

	<?php
	// add row for country average
	if (count($presences) > 1) :
	$totalPop = 0;
	$totalTarget = 0;
	foreach ($presences as $p) {
		$totalPop += $p->popularity;
		$totalTarget += $p->getTargetAudience();
	}
	$avPop = round(100*$totalPop/count($presences))/100;
	$avTarget = round(100*$totalTarget/count($presences))/100;
	?>

	<tr class="average">
		<td>Country Average</td>
		<td><?php echo number_format($avPop) . ' fans/followers'; ?></td>
		<td><?php echo number_format($avTarget); ?></td>
		<?php foreach ($this->country->getKpiAverages() as $key=>$value) : ?>
			<td>
				<div class="traffic-light" style="background-color:<?php echo $this->trafficLight()->color($value, $key); ?>;"></div>
				<?php echo $this->trafficLight()->label($value, $key); ?>
			</td>
		<?php endforeach; ?>
		<td></td>
	</tr>
	<?php endif; ?>

</table>

<?php endif; ?>