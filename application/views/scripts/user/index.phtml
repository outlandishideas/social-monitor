<?php
$buttons = array();
$new = $this->gatekeeper()->filter('<a class="button-bc" href="%url%">Add new</a>', array('controller'=>'user', 'action'=>'new'), null, true);
if ($new) {
    $buttons[] = $new;
}
array_unshift($buttons, '<div id="search-table"></div>');
?>

<h2 class="page-title">Users</h2>

<?php
if($buttons) {
    echo $this->partial('partials/button-bar.phtml', array('buttons'=>$buttons, 'dark'=>true));
}
?>

<table class="users text dtable" id="all-users" data-sort-col="name">
	<thead>
	<tr>
		<th class="name" data-name="name" data-sort="auto">Name</th>
		<th class="email" data-name="email" data-sort="auto">Email Address</th>
		<th class="user-level" data-name="user-level" data-sort="auto">User Level</th>
		<th class="access" data-name="access" data-sort="auto">Access rights</th>
		<th class="last-sign-in" data-name="last-sign-in" data-sort="auto">Last Sign In</th>
		<th class="options" data-name="options" data-sort="none" data-width="160px">Options</th>
	</tr>
	</thead>
	<tbody>
<?php foreach ($this->users as $user) : ?>
	<?php
		/** @var Model_User $user */
		$userLevel = array_key_exists($user->user_level, $this->userLevels) ? $this->userLevels[$user->user_level] : 'Unknown (' . $user->user_level . ')';
	?>
	<tr <?php if ($user->id == $this->user->id) echo 'class="current-user"'; ?>>
		<td class="name left-align"><?php echo $user->safeName; ?></td>
		<td class="email left-align"><?php echo $user->email; ?></td>
		<td class="user-level left-align"><?php echo $userLevel; ?></td>
		<td class="access left-align">
			<?php if ($user->isManager) : ?>
			all
			<?php else : ?>
			<ul class="entity-list">
				<?php $entities = $user->getAccessEntities(); if ($entities) : ?>
				<?php foreach($entities as $e) : ?>
					<li>
						<?php $url = $this->gatekeeper()->filter('%url%', array('controller'=>$e->controller, 'action'=>'view', 'id'=>$e->entity_id)); if ($url) : ?>
						<a href="<?php echo $url; ?>" title="<?php echo $e->title; ?>" class="entity <?php echo $e->entity_type; ?>">
							<span class="icon-large <?php echo $e->icon;?>"></span>
							<?php echo $e->text; ?>
						</a>
						<?php else : ?>
						<span title="<?php echo $e->title; ?>" class="entity <?php echo $e->entity_type; ?>">
							<span class="icon-large <?php echo $e->icon;?>"></span>
							<?php echo $e->text; ?>
						</span>
						<?php endif; ?>
					</li>
				<?php endforeach; ?>
				<?php else : ?>
				none
				<?php endif; ?>
			</ul>
			<?php endif; ?>
		</td>
		<td class="last-sign-in left-align"><?php echo $this->prettyDate($user->last_sign_in, 'Never signed in'); ?></td>
		<td class="cell-options">
			<?php
				$links = array();
				if ($this->user->id == $user->id) {
					$links['<a href="%url%" class="button-bc">Edit</a>'] = array('controller'=>'user', 'action'=>'edit-self');
				} else {
					$links['<a href="%url%" class="button-bc">Edit</a>'] = array('controller'=>'user', 'action'=>'edit', 'id'=>$user->id);
					if (!$user->isManager) {
						$links['<a href="%url%" class="button-bc">Access Rights</a>'] = array('controller'=>'user', 'action'=>'manage', 'id'=>$user->id);
					}
					$links['<a href="%url%" class="autoConfirm button-bc">Delete</a>'] = array('controller'=>'user', 'action'=>'delete', 'id'=>$user->id);
				}
				$links = $this->gatekeeper()->filterAll($links);
			?>
			<ul>
				<?php foreach($links as $link): ?>
					<li><?php echo $link; ?></li>
				<?php endforeach; ?>
			</ul>
		</td>
	</tr>
<?php endforeach; ?>
	</tbody>
</table>