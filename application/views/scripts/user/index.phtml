<?php $button = $this->gatekeeper()->filter('<a class="button-bc" href="%url%">Add new</a>', array('controller'=>'user', 'action'=>'new'), null, true); ?>

<h2 class="page-title">Users</h2>

<?php if($button): ?>

	<div class="button-bc-bar">
		<div class="row bk-dark">
			<div class="small-24 columns">
				<ul class="button-group">
					<li><?php echo $button; ?></li>
				</ul>
			</div>
		</div>
	</div>

<?php endif; ?>


<table class="users text">
	<thead>
	<tr>
		<th class="name">Name</th>
		<th class="email">Email Address</th>
		<th class="user-level">User Level</th>
		<th class="access">Access rights</th>
		<th class="last-sign-in">Last Sign In</th>
		<th></th>
	</tr>
	</thead>
	<tbody>
<?php foreach ($this->users as $user) : ?>
	<?php
		/** @var Model_User $user */
		$userLevel = array_key_exists($user->user_level, $this->userLevels) ? $this->userLevels[$user->user_level] : 'Unknown (' . $user->user_level . ')';
	?>
	<tr <?php if ($user->id == $this->user->id) echo 'class="current-user"'; ?>>
		<td class="name left-align"><?php echo $user->safeName; ?></td>
		<td class="email"><?php echo $user->email; ?></td>
		<td class="user-level"><?php echo $userLevel; ?></td>
		<td class="access">
			<?php if ($user->isManager) : ?>
			all
			<?php else : ?>
			<ul class="entity-list">
				<?php $entities = $user->getAccessEntities(); if ($entities) : ?>
				<?php foreach($entities as $e) : ?>
					<li>
						<?php $url = $this->gatekeeper()->filter('%url%', array('controller'=>$e->controller, 'action'=>'view', 'id'=>$e->entity_id)); if ($url) : ?>
						<a href="<?php echo $url; ?>" title="<?php echo $e->title; ?>" class="entity <?php echo $e->entity_type; ?>">
							<span class="icon-large <?php echo $e->icon;?>"></span>
							<?php echo $e->text; ?>
						</a>
						<?php else : ?>
						<span title="<?php echo $e->title; ?>" class="entity <?php echo $e->entity_type; ?>">
							<span class="icon-large <?php echo $e->icon;?>"></span>
							<?php echo $e->text; ?>
						</span>
						<?php endif; ?>
					</li>
				<?php endforeach; ?>
				<?php else : ?>
				none
				<?php endif; ?>
			</ul>
			<?php endif; ?>
		</td>
		<td class="last-sign-in"><?php echo $this->prettyDate($user->last_sign_in, 'Never signed in'); ?></td>
		<td>
			<?php
				$links = array();
				if ($this->user->id == $user->id) {
					$links['<a href="%url%"Edit</a>'] = array('controller'=>'user', 'action'=>'edit-self');
				} else {
					$links['<a href="%url%">Edit</a>'] = array('controller'=>'user', 'action'=>'edit', 'id'=>$user->id);
					if (!$user->isManager) {
						$links['<a href="%url%">Access Rights</a>'] = array('controller'=>'user', 'action'=>'manage', 'id'=>$user->id);
					}
					$links['<a href="%url%" class="autoConfirm">Delete</a>'] = array('controller'=>'user', 'action'=>'delete', 'id'=>$user->id);
				}
				$links = $this->gatekeeper()->filterAll($links);
			?>
			<ul>
				<?php foreach($links as $link): ?>
					<li><?php echo $link; ?></li>
				<?php endforeach; ?>
			</ul>
		</td>
	</tr>
<?php endforeach; ?>
	</tbody>
</table>