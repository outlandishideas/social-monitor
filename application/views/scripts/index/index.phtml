<form>
    <select id="select-kpi" onchange="drawRegionsMap()">
        <option value="kpi_1">KPI 1</option>
        <option value="kpi_2">KPI 2</option>
        <option value="kpi_3">KPI 3</option>
    </select>
</form>

<div id="geo-map" style="height:800px; width: 100%">
</div>

<div id="selected-country" class="key">
    <h2>Your Selected Country</h2>
    <ul></ul>
</div>



<script type='text/javascript' src='https://www.google.com/jsapi'></script>
<script type='text/javascript'>



    var json = <?php echo $this->jsonCountries; ?>;
    var fromJSON = "['Country', '"+ currentMetric() +"']";


    function populateDataTableFromJSON(data){

        for(var i=0;i<json.length;i++){
            var obj = json[i];
            for(var key in obj){
                var attrValue = obj[key];
                if(key == 'name'){
                    var country = attrValue
                } else if (key == 'kpis'){
                    for(var kpi in attrValue){
                        var current = currentMetric();
                        if(kpi == current){
                            var metric = attrValue[kpi];
                        }
                    }
                }

            }
            if(country && metric){
                data.addRow([country, metric]);
            }
        }
        return data;
    }

    function currentMetric() {
        var select = document.getElementById('select-kpi');
        if(select){
            console.log(select.value);
            return select.value;
        } else {
            return 'kpi_1';
        }

    }
    google.load('visualization', '1', {'packages': ['geochart']});
    google.setOnLoadCallback(drawRegionsMap);

    function drawRegionsMap() {

        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Employee Name');
        data.addColumn('number', currentMetric());

        data = populateDataTableFromJSON(data);

        var options = {colorAxis: {minValue: 0, maxValue: 1000, colors: ['orange', 'green']}};

        var chart = new google.visualization.GeoChart(document.getElementById('geo-map'));
        chart.draw(data, options);

        google.visualization.events.addListener(chart, 'select',
            selectHandler);

        function selectHandler(e) {
            var selection = chart.getSelection();
            var row=selection[0].row;
            var code = data.getValue(row,0);

            var ret = app.api.getCountryData(code);

        }

    }


</script>