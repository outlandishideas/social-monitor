<?php
    $links = $this->gatekeeper()->filterAll(array(
        '<a class="button add" href="%url%">Add new Country</a>' => array('action' => 'new', 'type'=>'campaign')
    ));
?>

<div id="geo-map"></div>

<div id="overview">
    <h2></h2>
    <dl>
    </dl>
</div>

<script type='text/javascript' src='https://www.google.com/jsapi'></script>
<script type='text/javascript'>



    var json = <?php echo $this->jsonCountries; ?>;


    function populateDataTableFromJSON(data){

        for(var i=0;i<json.length;i++){
            var obj = json[i];
            for(var key in obj){
                var attrValue = obj[key];
                if(key == 'name'){
                    var country = attrValue;
                } else if (key == 'target') {
                    var target = attrValue;
                } else if (key == 'kpis'){
                    for(var kpi in attrValue){
                        var current = currentMetric();
                        if(kpi == current){
                            var value = 0;
                            for (var p in attrValue[kpi]){
                                value += parseInt(attrValue[kpi][p].popularity);
                            }
                            var length = attrValue[kpi].length;
                            value = value/length;
                            var metric = Math.floor((value/target)*100);
                        }
                    }
                }

            }
            if(country && metric){
                data.addRow([country, metric]);
            }
        }
        return data;
    }

    function currentMetric() {
        var select = document.getElementById('select-kpi');
        if(select){
            console.log(select.value);
            return select.value;
        } else {
            return 'popularity';
        }

    }
    google.load('visualization', '1', {'packages': ['geochart']});
    google.setOnLoadCallback(drawRegionsMap);

    function drawRegionsMap() {

        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Employee Name');
        data.addColumn('number', currentMetric() +' (in %)');

        data = populateDataTableFromJSON(data);

        var options = {colorAxis: {minValue: 0, maxValue: 100, colors: ['orange', 'green']}};

        var chart = new google.visualization.GeoChart(document.getElementById('geo-map'));
        chart.draw(data, options);

        google.visualization.events.addListener(chart, 'select',
            selectHandler);

        function selectHandler(e) {
            var selection = chart.getSelection();
            var row=selection[0].row;
            var code = data.getValue(row,0);

            var ret = app.api.getCountryData(code);


        }

    }


</script>