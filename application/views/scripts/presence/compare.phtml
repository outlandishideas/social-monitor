<?php
//print_r($this->presence);
/** @var \Symfony\Component\Translation\Translator $translator */
$translator = $this->translate();
?>

<div id="pickers">
	<?php echo $this->render('partials/chart-picker.phtml'); ?>
	<?php echo $this->render('partials/daterange.phtml'); ?>
</div>

<?php
    $links = $this->gatekeeper()->filterAll(array(
        '<a class="button add" href="%url%"><span class="icon-plus"></span>  '.$translator->trans('Presence.compare.button.create-sbu').'</a>' => array('controller'=>'group','action' => 'new', 'presences'=>implode(',', array_keys($this->compareData))),
    ), null, true);
    if ($links) {
        echo '<div class="buttons">' . implode('', $links) . '</div>';
    }
?>

<?php if (empty($this->compareData)) : ?>

    <h3><?php echo $translator->trans('Presence.index.table-empty'); ?></h3>

<?php else : ?>

    <div id="charts" data-controller="presence">
        <?php
        $currentId = 1;
        foreach($this->compareData as $data) : ?>
        <div class="section-title">
	        <h2><?php echo $this->partial('partials/presence_inline.phtml', array('presence'=>$data->presence)); ?></h2>
        </div>
	    <div class="presence-charts">
            <?php
	        foreach ($data->graphs as $graph) {
                $graph->id = $currentId++;
                $this->graph = $graph;
                echo $this->render('partials/chart.phtml');
            }
	        ?>
		</div>
        <?php endforeach; ?>
    </div>

	<div class="section-title">
		<h2><span class="icon-bar-chart icon-large"></span> <?php echo $translator->trans('Presence.compare.chart-title'); ?></h2>
	</div>

    <table class="text">

        <tr>
            <th><?php echo $translator->trans('Presence.handle'); ?></th>
            <?php foreach ($this->tableMetrics as $key=>$label) : ?>
                <th><?php echo $label; ?></th>
            <?php endforeach; ?>
        </tr>

        <?php foreach($this->compareData as $data) : /** @var Model_Presence $presence */ $presence = $data->presence; ?>
            <tr>
                <td>
                    <div class="presence <?php echo $presence->type; ?>">
                        <?php $url = $this->gatekeeper()->filter('%url%', array('controller'=>'presence', 'action'=>'view', 'id'=>$presence->id)); if ($url) : ?>
	                    <a href="<?php echo $url; ?>"><?php echo $presence->handle; ?></a>
	                    <?php else : echo $presence->handle; endif; ?>
                        <a href="<?php echo $presence->page_url; ?>" target="_blank" class="icon external"></a>
                    </div>
                </td>
                <?php $kpiData = $presence->getKpiData(); foreach ($this->tableMetrics as $key=>$label) : $value = $kpiData[$key]; ?>
                    <td>
                        <span class="icon-circle icon-large pull-left" data-value="<?php echo $value; ?>" style="color:<?php echo $this->trafficLight()->color($value, $key); ?>;"></span>
                        <?php echo $this->trafficLight()->label($value, $key); ?>
                    </td>
                <?php endforeach; ?>
            </tr>
        <?php endforeach; ?>

    </table>

<?php endif; ?>
