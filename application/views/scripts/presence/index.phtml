<?php
$links = $this->gatekeeper()->filterAll(array(
	'<a class="button add" href="%url%"><span class="icon-plus"></span>  Add new</a>' => array('action' => 'new'),
    '<a class="button compare" data-href="%url%" href="%url%"><span class="icon-search"></span>  Compare</a>' => array('action' => 'compare', 'id'=>'')
));
if ($links) {
	echo '<div class="buttons">' . implode('', $links) . '</div>';
}
?>

<table class="text dtable" id="all-presences">
	<thead>
		<tr>
            <th data-name="compare" data-sort="checkbox"><span class="icon-check"></span></th>
			<th data-name="handle" data-sort="auto">Handle</th>
            <th data-name="sign-off" data-sort="data-value-numeric"><abbr title="Digital Sign-off">SO</abbr></th>
            <th data-name="branding" data-sort="data-value-numeric"><abbr title="Branding">B</abbr></th>
			<th data-name="popularity" data-sort="fuzzy-numeric">Audience</th>
			<th data-name="target" data-sort="fuzzy-numeric">Target audience</th>
			<?php foreach ($this->tableMetrics as $key=>$label) : ?>
			<th data-name="<?php echo $key; ?>" data-sort="traffic-light" data-width="150px"><?php echo $label; ?></th>
			<?php endforeach; ?>
			<th data-name="options" data-width="150px"></th>
		</tr>
	</thead>
	<tbody>
		<?php /** @var $presence Model_Presence */ ?>
		<?php foreach ($this->presences as $presence) : ?>
		<tr>
            <td><input type="checkbox" id="presence-<?php echo $presence->id; ?>" class="compare-checkbox" data-name="<?php echo $presence->handle; ?>" name="presences" value="<?php echo $presence->id; ?>" ></td>
			<td>
                <?php echo $this->partial('partials/presence_inline.phtml',  array('presence' => $presence)); ?>
                <?php if (!$presence->uid) : ?>
                [not found]
                <?php endif; ?>
			</td>
            <td>
                <span class="<?php echo $presence->sign_off ? 'icon-ok-sign': 'icon-remove-sign';?> icon-large"
                      data-value="<?php echo $presence->sign_off ? 1 : 0 ;?>"></span>
            </td>
            <td>
                <span
                    class="<?php echo $presence->branding ? 'icon-ok-sign': 'icon-remove-sign';?> icon-large"
                    data-value="<?php echo $presence->branding ? 1 : 0 ;?>"></span>
            </td>
			<td><?php echo number_format($presence->popularity) . ' ' . ($presence->isForFacebook() ? 'fans' : 'followers'); ?></td>
			<td><?php echo number_format($presence->getTargetAudience()) . ' ' . ($presence->isForFacebook() ? 'fans' : 'followers'); ?></td>
			<?php
			$kpiData = $presence->getKpiData();
			foreach ($this->tableMetrics as $key=>$label) :
				$value = $kpiData[$key];
			?>

                <td>
                    <span class="icon-circle icon-large pull-left" data-value="<?php echo $value; ?>" style="color:<?php echo $this->trafficLight()->color($value, $key); ?>;"></span>
                    <?php echo $this->trafficLight()->label($value, $key); ?>
                </td>
			<?php endforeach; ?>
			<td>
				<?php
				$links = $this->gatekeeper()->filterAll(array(
					'- <a href="%url%">Edit</a>' => array('action'=>'edit', 'id'=>$presence->id),
					'- <a href="%url%" class="autoConfirm">Delete</a>' => array('action'=>'delete', 'id'=>$presence->id)
				));
				echo implode('<br />', $links);
				?>
			</td>
		</tr>
		<?php endforeach; ?>
	</tbody>
</table>
