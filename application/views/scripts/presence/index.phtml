<?php
$kpis = Model_Campaign::getKpis();
$links = $this->gatekeeper()->filterAll(array(
	'<a class="button add" href="%url%">Add new</a>' => array('action' => 'new')
));
if ($links) {
	echo '<p>' . implode('', $links) . '</p>';
}
?>

<table class="text dtable standard" id="all-presences">
	<thead>
		<tr>
			<th data-name="handle" data-sort="auto">Handle</th>
			<th data-name="popularity" data-sort="fuzzy-numeric">Audience</th>
			<th data-name="target" data-sort="fuzzy-numeric">Target audience</th>
			<?php foreach ($kpis as $key=>$label) : ?>
			<th data-name="<?php echo $key; ?>" data-sort="traffic-light" data-width="150px"><?php echo $label; ?></th>
			<?php endforeach; ?>
			<th data-name="options" class="options"></th>
		</tr>
	</thead>
	<tbody>
		<?php /** @var $presence Model_Presence */ ?>
		<?php foreach ($this->presences as $presence) : ?>
		<tr>
			<td>
				<div class="presence <?php echo $presence->type; ?>">
					<a href="<?php echo $this->url(array('action'=>'view', 'id'=>$presence->id)); ?>" title="<?php echo $presence->label; ?>"><?php echo $presence->handle; ?></a>
					<?php if (!$presence->uid) : ?>
					[not found]
					<?php endif; ?>
					<a href="<?php echo $presence->page_url; ?>" target="_blank" class="icon external"></a>
				</div>
			</td>
			<td><?php echo number_format($presence->popularity) . ' ' . ($presence->type == Model_Presence::TYPE_FACEBOOK ? 'fans' : 'followers'); ?></td>
			<td><?php echo number_format($presence->getTargetAudience()) . ' ' . ($presence->type == Model_Presence::TYPE_FACEBOOK ? 'fans' : 'followers'); ?></td>
			<?php
			$kpiData = $presence->getKpiData();
			foreach ($kpis as $key=>$label) :
				$value = $kpiData[$key];
			?>
				<td>
					<div class="traffic-light" data-value="<?php echo $value; ?>" style="background-color:<?php echo $this->trafficLight()->color($value, $key); ?>;"></div>
					<span><?php echo $this->trafficLight()->label($value, $key); ?></span>
				</td>
			<?php endforeach; ?>
			<td class="options">
				<?php
				$links = $this->gatekeeper()->filterAll(array(
					'<a href="%url%">Edit</a>' => array('action'=>'edit', 'id'=>$presence->id),
					'<a href="%url%">Update info</a>' => array('action'=>'update', 'id'=>$presence->id),
					'<a href="%url%" class="autoConfirm">Delete</a>' => array('action'=>'delete', 'id'=>$presence->id)
				));
				echo implode(' | ', $links);
				?>
			</td>
		</tr>
		<?php endforeach; ?>
	</tbody>
</table>
